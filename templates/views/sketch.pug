extends ../layouts/default

block content
	.container: .row
		if !data.sketch
			h2 Invalid Sketch.
		else
			.col-sm-12.col-md-12
				.page-header
					//- a(href='/api/sketch/' + data.sketch.id + '/play').display-link.pull-right â–¶ Display
					a(href='/api/sketch/' + data.sketch.id + '/play').pull-right
						button(type='submit').display-btn.btn.btn-primary â–¶ Display
					- var title = data.sketch.title
					- var date = data.sketch._.modifiedDate.format('D/M/Y')
					h1 <strong>#{title}</strong> <small>#{date}</small>
				div(style='position:relative;width:100%;height:0;padding-bottom:56.25%;')
					iframe(style='position:absolute;top:0;left:0;width:100%;height:100%;' frameborder="0" scrolling="no" src="/view-static/"+data.sketch.localDir)
			.col-sm-4.col-md-4
				.channel-heading
					if data.sketch.ipfsHash
						a(href='/api/sketch/' + data.sketch.id + '/sync').btn.btn-default.pull-right Update address
					else
						a(href='/api/sketch/' + data.sketch.id + '/sync').btn.btn-default.pull-right Create address
					h2 Channels
				.list-group
					.list-group-item
						if data.channels && data.channels.length
							ul.nav.nav-pills
								each channel in data.channels
									- var channelActive = data.sketch.channels.some(x => x.key === channel.key);
									li(class=(channelActive ? 'active' : ''))
										a(href='?channel=true&_id='+channel._id)=channel.name
				.channel-sync
					if data.sketch.ipfsHash
						- var shortHash = data.sketch.ipfsHash.substring(0,24);
						p Address:
							code
								a(href='https://gateway.ipfs.io/ipfs/' + data.sketch.ipfsHash, target='_blank')=shortHash
				hr
				a(href='/view-static/' + data.sketch.localDir, target='_blank').btn.btn-default.pull-right Local
				if data.sketch.ipfsHash
					a(href='https://gateway.ipfs.io/ipfs/' + data.sketch.ipfsHash, target='_blank').btn.btn-default.pull-right Gateway
				h2 Preview
				if data.sketch.prefThumb
					h4 prefthumb avail
				else
					h4 prefthumb notavail
				hr
				a(href='?delete=true', data-toggle='tooltip', data-placement='auto bottom', title='Warning! This cannot be undone.').list-group-item Delete
			.col-sm-8.col-md-8
				.details-heading
					a(href='/view-static/'+data.sketch.localDir+'/index.html' id='edit-html').btn.btn-default.pull-right âŒ¨&emsp;Edit
					h2 Details
					form(action='/api/sketch/'+data.sketch.id+'/update' method='post' id='sketch-form').form-horizontal
						fieldset(disabled='disabled')
							input(type='hidden', name='action', value='save')
							.form-group(class=validationErrors.message ? 'has-error' : null)
								label.col-sm-2.control-label Title
								.col-sm-10
									textarea(name='title' id='title-area' rows=1 value='hi' required).form-control= data.sketch.title
							.form-group(class=validationErrors.message ? 'has-error' : null)
								label.col-sm-2.control-label index.html
								.col-sm-10
									textarea(name='code' id='code-area' style='font-family:monospace;' placeholder='HTML sketch...' rows=24 required).form-control= formData.sketch
							.form-group
								.col-sm-10.col-sm-offset-2
									button(type='submit').btn.btn-primary Save

			//- .col-sm-4.col-md-4
			//- 	//- iframe(width="750px" height="750px" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="/view-static/"+data.sketch.localDir).img-responsive
			//- 	if data.sketch.prefThumb
			//- 		//- - var imgThumb = '/view-static/'+sketch.localDir+'/'+sketch.prefThumb;
			//- 		div(class='thumbnail')
			//- 		h4 pls
			//- 	else
			//- 		h4 Select a preferred image
			//- 	.panel.panel-default
			//- 		.panel-heading
			//- 			a(href='/api/sketch/' + data.sketch.id + '/play').display-link.pull-right Display
			//- 			h3(class='panel-title')=data.sketch.title
			//- 		.list-group
			//- 			a(href='/api/sketch/' + data.sketch.id + '/sync').list-group-item Share with peers
			//- 			.list-group-item
			//- 				p Channels:
			//- 				if data.channels && data.channels.length
			//- 					ul.nav.nav-pills
			//- 						each channel in data.channels
			//- 							- var channelActive = data.sketch.channels.some(x => x.key === channel.key);
			//- 							li(class=(channelActive ? 'active' : ''))
			//- 								a(href='?channel=true&_id='+channel._id)=channel.name
			//- 			a(href='/view-static/' + data.sketch.localDir, target='_blank').list-group-item Preview on device
			//- 			if data.sketch.ipfsHash
			//- 				a(href='/api/sketch/' + data.sketch.id + '/play', target='_blank').list-group-item Preview on gateway
			//- 		.panel-footer
			//- 			a(href='?delete=true', data-toggle='tooltip', data-placement='auto bottom', title='Warning! This cannot be undone.').list-group-item Delete
			.col-sm-8.col-md-8
				.page-header
					a(href='?screenshot=true' id='make-editable').btn.btn-default.pull-right ðŸ“·&emsp;Screenshot
					h1 Saved Images
				if data.thumbnails.length
					.row
						each thumbnail in data.thumbnails
							.col-xs-2
								img(src='/view-static/'+data.sketch.localDir+'/'+thumbnail).img-thumbnail
				else
					h4 No thumbnails
				//- .page-header
				//- 	a(href='/view-static/'+data.sketch.localDir+'/index.html' id='edit-html').btn.btn-default.pull-right âŒ¨&emsp;Edit
				//- 	h1 Source Code
				//- form(method='post').form-horizontal
				//- 	fieldset(disabled='disabled')
				//- 		input(type='hidden', name='action', value='save')
				//- 		.form-group(class=validationErrors.message ? 'has-error' : null)
				//- 			label.col-sm-2.control-label index.html
				//- 			.col-sm-10
				//- 				textarea(name='code' id='code-area' style='font-family:monospace;' placeholder='HTML sketch...' rows=24 required).form-control= formData.sketch
				//- 		.form-group
				//- 			.col-sm-10.col-sm-offset-2
				//- 				p.help-block Note: others can see your
				//- 				button(type='submit').btn.btn-primary Save

				//- article
				//- 	//- p: a(href='/browse') &larr; back to the sketches
				//- 	//- hr
				//- 	if !data.sketch
				//- 		h2 Invalid Sketch.
				//- 	else
				//- 		header
				//- 			h1= data.sketch.title
				//- 			if data.sketch.ipnsHash
				//- 				h2: a(href='?update=ipns') Update IPNS #{data.sketch.ipnsHash}
				//- 			h5 Posted 
				//- 				if data.sketch.publishedDate
				//- 					| on #{data.sketch._.publishedDate.format('MMMM Do, YYYY')} 
				//- 				if data.sketch.channels && data.sketch.channels.length
				//- 					| in 
				//- 					each channel, channel_i in data.sketch.channels
				//- 						a(href='/browse/' + channel.key)= channel.name
				//- 						if channel_i < data.sketch.channels.length - 1
				//- 							| , 
				//- 						else
				//- 							|  
				//- 				if data.sketch.author
				//- 					| by #{data.sketch.author.name.first}
				//- 		.sketch
					//if data.sketch.image.exists
					//	.image-wrap: img(src=data.sketch._.image.fit(750,450)).img-responsive
					//!= data.sketch.content.full
block js
	script.
		jQuery(function($) {
			// make code editable
			$('#edit-html').click(function(e){
				e.preventDefault();
				$('fieldset').removeAttr('disabled');
				//- var sketchURL = $(this).attr('href');
				//- $.ajax({url: sketchURL, async: true, 
				//- 	error: function(){
				//- 		var flashMsg = '<div class="alert alert-error">â“˜&emsp;errorrr</div>'
				//- 		$('#flash-messages').prepend(flashMsg);
				//- 	},
				//- 	success: function(result){
				//- 		$('#code-area').val(result);
				//- 	}
				//- });
			});
			// load HTML into form
			var sketchURL = $('#edit-html').attr('href');
			$.ajax({url: sketchURL, async: true, 
				error: function(){
					var flashMsg = '<div class="alert alert-error">â“˜&emsp;errorrr</div>'
					$('#flash-messages').prepend(flashMsg);
				},
				success: function(result){
					$('#code-area').val(result);
				}
			});
			// initialise tooltip to appear on Delete button
			$('[data-toggle="tooltip"]').tooltip(); 
			// send form ajax
			$('#sketch-form').submit(function(event){
				event.preventDefault();
				var post_url = $(this).attr('action');
				var request_method = $(this).attr('method');
				var form_data = $(this).serialize();
				$.ajax({
					url: post_url,
					type: request_method,
					data: form_data
				}).done(function(response){
					if(response.success){
						notifier.success('Update complete. Please ');
					}else{
						notifier.alert('Error updating sketch');
					}
					console.log(response);
					//$('#body').html(response);
				});
			});
		});